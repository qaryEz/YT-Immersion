<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Remote</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --font: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", "Hiragino Sans", sans-serif;
            --text-main: #ffffff;
            --text-sub: rgba(255, 255, 255, 0.55);
            --bg-base: #000;
            --ease-apple: cubic-bezier(0.25, 1, 0.5, 1);
        }

        /* --- 1. 画面ロック --- */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: var(--bg-base); color: var(--text-main);
            font-family: var(--font);
            overflow: hidden; position: fixed; inset: 0;
            touch-action: none; user-select: none; -webkit-user-select: none;
        }

        /* --- 背景 --- */
        #backdrop {
            position: absolute; inset: -20px; z-index: -2;
            background-color: #111;
            background-size: cover; background-position: center;
            filter: blur(90px) brightness(0.4) saturate(1.5);
            transform: scale(1.2); transition: background-image 1.5s ease;
            pointer-events: none;
        }

        /* --- メインコンテナ --- */
        .container {
            width: 100%; height: 100%;
            padding: max(20px, env(safe-area-inset-top)) 24px max(30px, env(safe-area-inset-bottom)) 24px;
            box-sizing: border-box; z-index: 10;
            display: flex; flex-direction: column;
        }

        /* === スマホ用レイアウト (縦) === */
        .player-side { display: contents; }
        
        #artwork-wrapper { 
            order: 1; width: 100%; display: flex; justify-content: center; 
            margin-bottom: 20px; flex-shrink: 0;
        }
        .meta-info { 
            order: 2; width: 100%; text-align: center; 
            margin-bottom: 10px; flex-shrink: 0;
        }
        .lyrics-side { 
            order: 3; flex: 1; min-height: 0; position: relative; width: 100%;
            margin-bottom: 15px;
            mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
        }
        .controls-area { order: 4; width: 100%; flex-shrink: 0; }

        /* スマホ用アートワークサイズ */
        #artwork-card {
            width: 65vw; height: 65vw;
            max-width: 280px; max-height: 280px;
            max-height: 32vh; aspect-ratio: 1/1;
            border-radius: 12px; background-color: rgba(255,255,255,0.05);
            background-size: cover; background-position: center;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            transition: transform 0.5s var(--ease-apple);
        }

        /* === iPad / PC用レイアウト (横) === */
        @media (min-aspect-ratio: 4/3) and (min-width: 700px) {
            .container {
                display: grid;
                grid-template-columns: 45% 55%;
                grid-template-rows: 100%;
                padding: 60px 80px; gap: 80px;
                align-items: center;
            }
            
            .player-side {
                display: flex; flex-direction: column; 
                justify-content: center; align-items: center;
                height: 100%; width: 100%; 
                max-width: 500px; margin: 0 auto; order: 1;
            }
            
            .lyrics-side { 
                order: 2; height: 100%; margin: 0; 
                padding-left: 40px;
                mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%);
                -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%);
            }
            
            #artwork-wrapper { order: initial; margin-bottom: 40px; justify-content: center; width: 100%; }
            .meta-info { 
                order: initial; margin-bottom: 20px; width: 100%; 
                text-align: left; align-items: flex-start; padding-left: 4px; 
            }
            .controls-area { order: initial; width: 100%; margin-top: 0; }
            
            #artwork-card { 
                width: 100% !important; aspect-ratio: 1/1; 
                max-width: 400px; max-height: 400px;
                min-width: 300px;
                box-shadow: 0 40px 100px rgba(0,0,0,0.6);
            }
            
            .buttons-row { justify-content: space-between !important; gap: 40px !important; margin-left: 0; width: 100%; max-width: 350px; margin: 15px auto 0;}
            .volume-wrap { justify-content: center !important; }
            
            #lyrics-list { text-align: left; padding-left: 20px; }
            .lyric-item { transform-origin: left center; font-size: 32px; }
            .lyric-item.active { font-size: 48px; transform: scale(1.02) translateX(10px); }
        }

        /* --- 共通パーツ --- */
        
        #artwork-card.playing { transform: scale(1.03); }

        .meta-info { display: flex; flex-direction: column; gap: 6px; }
        #song-title { 
            font-size: 24px; font-weight: 700; line-height: 1.2; letter-spacing: -0.02em;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        #artist-name { 
            font-size: 18px; color: var(--text-sub); font-weight: 500; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }

        /* 歌詞リスト */
        #lyrics-list {
            list-style: none; padding: 0; margin: 0;
            width: 100%; height: 100%; 
            overflow-y: auto; overscroll-behavior-y: contain; 
            -webkit-overflow-scrolling: touch; text-align: center;
            scrollbar-width: none; -ms-overflow-style: none;
        }
        #lyrics-list::-webkit-scrollbar { display: none; }

        .lyric-item {
            font-size: clamp(20px, 5vw, 24px); font-weight: 700; line-height: 1.6;
            color: rgba(255,255,255,0.3);
            margin: 16px 0; cursor: pointer;
            transition: all 0.4s ease; transform-origin: center center;
            word-wrap: break-word; overflow-wrap: break-word;
            padding: 0 10px;
            filter: blur(0.5px); transform: scale(0.95);
        }
        .lyric-item:active { opacity: 0.8; }
        .lyric-item.active {
            color: #fff; font-size: clamp(28px, 6vw, 36px);
            opacity: 1; filter: none; transform: scale(1.05);
            text-shadow: 0 0 30px rgba(255,255,255,0.4); margin: 24px 0;
        }
        .spacer { height: 50vh; pointer-events: none; }

        /* コントロール */
        .progress-area { width: 100%; margin-bottom: 5px; margin-top: 0; }
        .progress-wrap { width: 100%; height: 30px; display: flex; align-items: center; cursor: pointer; }
        input[type="range"] {
            -webkit-appearance: none; width: 100%; background: transparent;
            height: 100%; margin: 0; padding: 0; cursor: pointer; position: relative; z-index: 2; --p: 0%;
        }
        input[type="range"]:focus { outline: none; }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; border-radius: 2px;
            background: rgba(255, 255, 255, 0.15);
            background: linear-gradient(to right, #fff var(--p), rgba(255,255,255,0.15) var(--p));
            transition: height 0.2s;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 4px; width: 4px; border-radius: 50%;
            background: transparent; transition: all 0.2s; box-shadow: none;
        }
        .progress-wrap:active input::-webkit-slider-runnable-track { height: 8px; border-radius: 4px; }
        .progress-wrap:active input::-webkit-slider-thumb {
            height: 20px; width: 8px; background: #fff; margin-top: -6px;
            border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }

        .time-labels { display: flex; justify-content: space-between; margin-top: -8px; font-size: 11px; color: var(--text-sub); font-weight: 600; font-variant-numeric: tabular-nums; }

        /* ボタン */
        .buttons-row {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; max-width: 300px; margin: 10px auto 0;
        }
        button {
            background: none; border: none; padding: 0; cursor: pointer;
            color: #fff; transition: transform 0.1s, opacity 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        button:active { transform: scale(0.85); opacity: 0.7; }
        
        .skip-icon { width: 36px; height: 36px; fill: #fff; opacity: 0.9; }
        #play-pause-btn {
            width: 70px; height: 70px; background: #fff; border-radius: 50%;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); color: #000;
        }
        .play-icon { width: 32px; height: 32px; fill: #000; margin-left: 4px; }
        #icon-pause.play-icon { margin-left: 0; }

        /* 音量バー */
        .volume-wrap {
            display: flex; align-items: center; justify-content: center; 
            gap: 15px; margin-top: 20px; opacity: 0.8; 
            width: 100%;
        }
        .vol-icon { width: 12px; fill: var(--text-sub); }
        
        input.vol-slider {
            -webkit-appearance: none; 
            width: 100%;
            height: 30px; background: transparent; margin: 0; cursor: pointer;
        }
        
        input.vol-slider::-webkit-slider-runnable-track { 
            height: 4px; border-radius: 2px; background: rgba(255,255,255,0.2); 
        }
        input.vol-slider::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; 
            background: #fff; border-radius: 50%; margin-top: -8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); transform: scale(1);
        }
        input.vol-slider:active::-webkit-slider-thumb { transform: scale(1.2); }

        #status-pill {
            position: absolute; top: 15px; right: 20px;
            font-size: 9px; font-weight: 700; letter-spacing: 1px;
            color: rgba(255,255,255,0.3); padding: 5px 12px; border-radius: 20px;
            background: rgba(0,0,0,0.2); backdrop-filter: blur(10px);
            z-index: 100; transition: opacity 0.5s;
        }
    </style>
</head>
<body>
    <div id="backdrop"></div>
    <div id="status-pill">Waiting</div>

    <div class="container">
        <div class="player-side">
            <div id="artwork-wrapper">
                <div id="artwork-card"></div>
            </div>

            <div id="meta-section" class="meta-info">
                <div id="song-title">Not Playing</div>
                <div id="artist-name">-</div>
            </div>

            <div id="controls-section" class="controls-area">
                <div class="progress-area">
                    <div class="progress-wrap">
                        <input type="range" id="seek-bar" min="0" max="100" value="0">
                    </div>
                    <div class="time-labels">
                        <span id="current-time">0:00</span>
                        <span id="duration">-:--</span>
                    </div>
                </div>

                <div class="buttons-row">
                    <button onclick="sendCommand('seek', -10)">
                        <svg class="skip-icon" viewBox="0 0 24 24"><path d="M19 6L9 12l10 6V6zM7 6v12h2V6H7z"/></svg>
                    </button>
                    
                    <button id="play-pause-btn" onclick="sendCommand('playpause')">
                        <svg id="icon-play" class="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        <svg id="icon-pause" class="play-icon" viewBox="0 0 24 24" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    </button>
                    
                    <button onclick="sendCommand('next')">
                        <svg class="skip-icon" viewBox="0 0 24 24"><path d="M5 18l10-6-10-6v12zm12-12v12h2V6h-2z"/></svg>
                    </button>
                </div>

                <div class="volume-wrap">
                    <svg class="vol-icon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                    <input type="range" id="volume" class="vol-slider" min="0" max="100" value="100">
                    <svg class="vol-icon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                </div>
            </div>
        </div>

        <div class="lyrics-side">
            <ul id="lyrics-list">
                <li class="spacer"></li>
                <li class="lyric-item" style="opacity:0.5; filter:none;">IMMERSION REMOTE</li>
                <li class="spacer"></li>
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener('touchmove', function(e) {
            if (!e.target.closest('#lyrics-list')) {
                e.preventDefault();
            }
        }, { passive: false });

        const params = new URLSearchParams(window.location.search);
        const targetId = params.get('id');
        const statusPill = document.getElementById('status-pill');
        const lyricsList = document.getElementById('lyrics-list');
        const seekBar = document.getElementById('seek-bar');
        const currTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');
        const artworkCard = document.getElementById('artwork-card');
        const backdrop = document.getElementById('backdrop');
        
        let conn = null;
        
        // ★★★  STUNサーバー設定を追加 ★★★
        const peerConfig = {
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' }
                ]
            }
        };
        
        // Peerの初期化時にconfigを渡す
        let peer = new Peer(peerConfig); 
        let isDragging = false; 
        let currentLyricsData = [];
        let autoScroll = true;

        peer.on('open', (id) => {
            if (targetId) connectToPC(targetId);
            else statusPill.innerText = "NO ID";
        });

        function connectToPC(id) {
            conn = peer.connect(id);
            conn.on('open', () => {
                statusPill.innerText = "CONNECTED";
                setTimeout(() => statusPill.style.opacity = 0, 3000);
            });
            conn.on('data', updateUI);
            conn.on('close', () => { statusPill.innerText = "DISCONNECTED"; statusPill.style.opacity = 1; });
            conn.on('error', () => statusPill.innerText = "ERROR");
        }

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0' : ''}${sec}`;
        }

        function renderLyrics(lyrics) {
            lyricsList.innerHTML = '<li class="spacer"></li>';
            lyrics.forEach((line, index) => {
                const li = document.createElement('li');
                li.className = 'lyric-item';
                li.id = `line-${index}`;
                li.innerText = line.text;
                li.onclick = () => {
                    sendCommand('scrub', line.time);
                    autoScroll = true;
                };
                lyricsList.appendChild(li);
            });
            lyricsList.innerHTML += '<li class="spacer"></li>';
        }

        function highlightLyric(index) {
            const items = document.querySelectorAll('.lyric-item');
            items.forEach(item => item.classList.remove('active'));
            const activeItem = document.getElementById(`line-${index}`);
            if (activeItem) {
                activeItem.classList.add('active');
                if (autoScroll) {
                    const containerHeight = lyricsList.clientHeight;
                    const itemTop = activeItem.offsetTop;
                    const itemHeight = activeItem.clientHeight;
                    lyricsList.scrollTo({
                        top: itemTop - containerHeight / 2 + itemHeight / 2,
                        behavior: 'smooth'
                    });
                }
            }
        }

        function updateUI(data) {
            if (data.type === 'time') {
                if (!isDragging) {
                    seekBar.max = data.duration;
                    seekBar.value = data.current;
                    currTimeEl.innerText = formatTime(data.current);
                    durationEl.innerText = "-" + formatTime(data.duration - data.current);
                    const percent = (data.current / data.duration) * 100;
                    seekBar.style.setProperty('--p', `${percent}%`);
                }
                return;
            }

            if (data.type === 'lyric_index') {
                highlightLyric(data.index);
                return;
            }

            if (data.type !== 'info') return;

            document.getElementById('song-title').innerText = data.title;
            document.getElementById('artist-name').innerText = data.artist;
            document.getElementById('icon-play').style.display = data.isPlaying ? 'none' : 'block';
            document.getElementById('icon-pause').style.display = data.isPlaying ? 'block' : 'none';

            if(data.isPlaying) artworkCard.classList.add('playing');
            else artworkCard.classList.remove('playing');

            if (data.thumbnail) {
                const url = `url('${data.thumbnail}')`;
                if (!artworkCard.style.backgroundImage.includes(data.thumbnail)) {
                    artworkCard.style.backgroundImage = url;
                    backdrop.style.backgroundImage = url; 
                }
            }

            if (data.allLyrics) {
                renderLyrics(data.allLyrics);
            }
        }

        function sendCommand(cmd, val) {
            if (navigator.vibrate) navigator.vibrate(10);
            if (conn && conn.open) {
                conn.send({ command: cmd, value: val });
                if (cmd === 'playpause') {
                    const play = document.getElementById('icon-play');
                    const pause = document.getElementById('icon-pause');
                    const isPaused = play.style.display !== 'none';
                    play.style.display = isPaused ? 'none' : 'block';
                    pause.style.display = isPaused ? 'block' : 'none';
                    if(isPaused) artworkCard.classList.add('playing');
                    else artworkCard.classList.remove('playing');
                }
            }
        }

        lyricsList.addEventListener('touchstart', () => { autoScroll = false; }, {passive: true});

        seekBar.addEventListener('input', (e) => {
            isDragging = true;
            currTimeEl.innerText = formatTime(e.target.value);
            const percent = (e.target.value / e.target.max) * 100;
            seekBar.style.setProperty('--p', `${percent}%`);
        });
        seekBar.addEventListener('change', (e) => {
            isDragging = false;
            sendCommand('scrub', e.target.value);
        });

        document.getElementById('volume').addEventListener('input', (e) => {
            sendCommand('volume', e.target.value);
        });
    </script>
</body>
</html>